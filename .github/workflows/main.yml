name: Check and Push Node Alpine Image

on:
  workflow_dispatch:

jobs:
  check-and-update-image:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: eu-central-1
      ECR_REPO: your-ecr-repo-name
      IMAGE_TAG: node-alpine
      LOCAL_TAG: node:alpine
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to ECR
        uses: aws-actions/amazon-ecr-login@v2
        with:
          mask-password: true
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Pull latest official image
        run: docker pull $LOCAL_TAG

      - name: Get current digest of official image
        id: official
        run: |
          docker inspect --format='{{index .RepoDigests 0}}' $LOCAL_TAG | cut -d'@' -f2 > official_digest.txt
          CURRENT_DIGEST=$(cat official_digest.txt)
          echo "CURRENT_DIGEST=$CURRENT_DIGEST" >> $GITHUB_ENV
          echo "Current digest: $CURRENT_DIGEST"

      - name: Download last known digest artifact (if any)
        id: download-artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: node-alpine-version
          path: ./

      - name: Compare with previous digest
        id: compare
        run: |
          if [[ -f alpine-version.txt ]]; then
            PREVIOUS_DIGEST=$(cat alpine-version.txt)
            echo "PREVIOUS_DIGEST=$PREVIOUS_DIGEST" >> $GITHUB_ENV
            echo "Previous digest: $PREVIOUS_DIGEST"
          else
            echo "PREVIOUS_DIGEST=none" >> $GITHUB_ENV
            echo "No previous digest found, assuming first run."
          fi

      - name: Compare and push if different
        id: push-image
        run: |
          if [[ "$PREVIOUS_DIGEST" == "$CURRENT_DIGEST" ]]; then
            echo "No update needed."
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            echo "Digest changed or first run. Pushing to ECR..."
            docker tag $LOCAL_TAG ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO }}:$IMAGE_TAG
            docker push ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO }}:$IMAGE_TAG
            echo "updated=true" >> $GITHUB_OUTPUT
          fi
          # Save current digest for artifact
          echo "$CURRENT_DIGEST" > alpine-version.txt

      - name: Upload current digest artifact (always)
        uses: actions/upload-artifact@v4
        with:
          name: node-alpine-version
          path: alpine-version.txt
